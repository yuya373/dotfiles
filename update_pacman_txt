#!/usr/bin/bash -eu

# WSLç’°å¢ƒã‹ã©ã†ã‹ã‚’åˆ¤å®š
if grep -qi microsoft /proc/version 2>/dev/null; then
    # WSLç’°å¢ƒã®å ´åˆ
    PACMAN_LIST="${HOME}/dotfiles/pacman_wsl.txt"
    PACMAN_AUR_LIST="${HOME}/dotfiles/pacman_aur_wsl.txt"
else
    # é€šå¸¸ã®Linuxç’°å¢ƒ
    PACMAN_LIST="${HOME}/dotfiles/pacman.txt"
    PACMAN_AUR_LIST="${HOME}/dotfiles/pacman_aur.txt"
fi

# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«
BACKUP_FILE="${PACMAN_LIST}.bak"
BACKUP_AUR_FILE="${PACMAN_AUR_LIST}.bak"

# æ—¢å­˜ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
if [[ -e "$PACMAN_LIST" ]]; then
    echo "ğŸ“¦ æ—¢å­˜ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒªã‚¹ãƒˆã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸­..."
    cp "$PACMAN_LIST" "$BACKUP_FILE"
fi

if [[ -e "$PACMAN_AUR_LIST" ]]; then
    cp "$PACMAN_AUR_LIST" "$BACKUP_AUR_FILE"
fi

echo "ğŸ“‹ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒªã‚¹ãƒˆã‚’æ›´æ–°ä¸­..."

# ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®ãŸã‚ã«trapã‚’è¨­å®š
trap 'echo "âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä¿æŒã—ã¾ã™ã€‚"; exit 1' ERR

# å…¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒªã‚¹ãƒˆï¼ˆæ˜ç¤ºçš„ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸã‚‚ã®ï¼‰
pacman -Qqe | sort > "$PACMAN_LIST"
echo "âœ… å…¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒªã‚¹ãƒˆ: $(wc -l < "$PACMAN_LIST") å€‹"

# AURãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã¿
pacman -Qqem | sort > "$PACMAN_AUR_LIST" 2>/dev/null || true
if [[ -s "$PACMAN_AUR_LIST" ]]; then
    echo "ğŸ”§ AURãƒ‘ãƒƒã‚±ãƒ¼ã‚¸: $(wc -l < "$PACMAN_AUR_LIST") å€‹"
else
    echo "â„¹ï¸  AURãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯ã‚ã‚Šã¾ã›ã‚“"
    rm -f "$PACMAN_AUR_LIST"
fi

# æ­£å¸¸ã«å®Œäº†ã—ãŸã‚‰ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å‰Šé™¤
if [[ -e "$BACKUP_FILE" ]]; then
    echo "ğŸ—‘ï¸  ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å‰Šé™¤ä¸­..."
    rm -f "$BACKUP_FILE"
fi

if [[ -e "$BACKUP_AUR_FILE" ]]; then
    rm -f "$BACKUP_AUR_FILE"
fi

echo "âœ¨ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒªã‚¹ãƒˆã®æ›´æ–°ãŒå®Œäº†ã—ã¾ã—ãŸï¼"

# git status ã‚’è¡¨ç¤ºï¼ˆå¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼‰
if command -v git &> /dev/null && [[ -d "${HOME}/dotfiles/.git" ]]; then
    cd "${HOME}/dotfiles"
    if grep -qi microsoft /proc/version 2>/dev/null; then
        # WSLç’°å¢ƒ
        if [[ -n $(git status --porcelain pacman*_wsl.txt 2>/dev/null) ]]; then
            echo ""
            echo "ğŸ“ å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:"
            git status --short pacman*_wsl.txt
        fi
    else
        # é€šå¸¸ã®Linuxç’°å¢ƒ
        if [[ -n $(git status --porcelain pacman*.txt 2>/dev/null | grep -v "_wsl.txt") ]]; then
            echo ""
            echo "ğŸ“ å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:"
            git status --short pacman*.txt | grep -v "_wsl.txt"
        fi
    fi
fi
