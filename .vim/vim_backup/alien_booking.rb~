# == Schema Information
#
# Table name: alien_bookings
#
#  id         :integer          not null, primary key
#  listing_id :integer          not null
#  start_at   :datetime         not null
#  minutes    :integer          not null
#  party      :integer
#  price      :integer
#  name       :string(50)
#  phone      :string(15)
#  email      :string(255)
#  memo       :string(255)
#  created_at :datetime
#  updated_at :datetime
#
# Indexes
#
#  listing_id_and_start_at  (listing_id,start_at) UNIQUE
#

class AlienBooking < ActiveRecord::Base
  self.primary_key = :id
  include CsvGeneratable

  belongs_to :listing

  validates_uniqueness_of :start_at, scope: :listing_id,
  message: "における自社予約はすでに登録済みです。"

  scope :start_at_gteq, ->(time){
    where arel_table[:start_at].gteq(time)
  }
  scope :within_day, ->(day){
    where arel_table[:start_at].gteq(day).
    and(arel_table[:start_at].lteq(day + 1.day))
  }
  scope :provider_is, ->(provider){
    joins(:listing).merge(Listing.where(provider_id: provider.id))

  }

  def end_at
    start_at + minutes.minutes
  end

end
