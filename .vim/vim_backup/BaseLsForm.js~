/*
 * BaseLsForm.js
 */
define(["core/component"], function(component) {
  return component.extend({
    install: function() {
      _.bindAll(this, "updateTime", "activate", "submitForm");
      this.select("submit").bind("click", this.submitForm);
      console.log(this.select("submit"))
      this.activate();
      // Initialize Data
      this.formData = {
        "date"  : null,
        "time"  : null,
        "hours" : null,
        "party" : null
      };
    },
    setFormData: function(key, value) {
      this.formData[key] = value;
      // console.log("this.formData", this.formData);
    },
    getFormData: function() {
      return this.formData;
    },
    activate: function() {
      this.select("date").pickadate(this.pickadateOptions());

      $time = this.select("time");
      this.timePicker= $time.timepicker({
        minuteStep   : 15,
        showSeconds  : false,
        showMeridian : false,
        defaultTime  : false,
        showWidgetOnAddonClick: false
      });

      this.timePicker.on("show.timepicker", function(e){
        if(!$time.val()){
          $time.timepicker('setTime', '12:00');
        }
      });

      //this.timePicker.on("changeTime.timepicker", this.updateTime);

      if(this.select("neighborhood").length > 0) {
        var $select = this.select("neighborhood");
        $select.select2();
      }

    },
    updateTime: function(e) {
    },
    pickadateOptions: function() {
      return {
        "today"   : "",
        "clear"   : "",
        "min"     : new Date()
      };
    },
    serialize: function(obj, prefix) {
       var str = [];
       for(var p in obj) {
           var k = prefix ? prefix + "[]" : p, v = obj[p];
           str.push(typeof v == "object" ?
                    this.serialize(v, k) :
                    encodeURIComponent(k) + "=" + (v ? encodeURIComponent(v) : ""));
       }
       return str.join("&");
    },
    submitForm: function(event) {
      event.preventDefault();
      var date = this.select("date").val().replace(/[^0-9]/g, "");
      this.setFormData("date", date);
      var time = this.select("time").val();
      this.setFormData("time", time);

      this.setFormData("hours", this.select("hours").val());
      this.setFormData("party", this.select("party").val());
      this.setFormData("usage_id", this.select("usage_id").val());
      this.setFormData("equipment_id",
                       $("input[name='equipment_id[]']:checked").map(function(){
                           return $(this).val();
                       }).get());
      this.setFormData("category_id",
                       $("input[name='category_id[]']:checked").map(function(){
                           return $(this).val();
                       }).get());
      this.setFormData("party_min", this.select("party_min").val());
      this.setFormData("price_min", this.select("price_min").val());
      this.setFormData("search_count",
                       parseInt(this.select("search_count").val()) + 1);
      this.setFormData("q", _.values(this.getFormData()).join(","));
      this.setFormData("neighborhood", this.select("neighborhood").val());

      window.location = this.props.nextUrl + "?" + this.serialize(this.getFormData());
    }
  });
});
