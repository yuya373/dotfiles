module ListingEditable
  extend ActiveSupport::Concern

  included do
    helper_method :done_icon
  end

  private

  def done_icon(is_done)
    is_done ? "icon-ok-sign" : "icon-edit"
  end

  def listing_params
    params.require(:listing).
      permit(:category_id, :thumb, :remove_thumb, :title, :capacity, :square,
             :acceptable_from_now_minutes, :provider_id, :is_display, :is_approved,
             :usage, :location, :desc, :access, :time, :min_booking_minutes,
             :latitude, :longitude, :zoom, :tel, :email,
             listing_usages_attributes: [
               :id, :usage_id, :description, :_destroy,
             ],
             listing_equipments_attributes: [
               :id, :equipment_id, :description, :_destroy,
             ],
             listing_stations_attributes: [
               :id, :station_id, :is_list, :access_minutes, :_destroy,
             ],
             photos_attributes: [
               :id, :image, :remove_image, :_destroy,
             ],
             note_attributes: [
               :id, :description,
             ],
             pre_settlements_attributes: [
               :id, :description, :_destroy,
             ],
             listing_setup_attributes: [
               :id, :is_done, :cleaning_minutes, :is_sales_guarantee,
             ],
             mail_template_attributes: [:id, :content],
             listing_agreement_attributes: [:id, :content],
             listing_cancellation_policy_attributes: [:id, :content],
             listing_location_attributes: [
               :id, :zip_code_before, :zip_code_after, :prefecture, :city, :lot_number, :building
             ]
            )
  end

  def build_nested_attributes(listing, nested, limit)
    (limit - listing.send(nested).size).times do
      listing.send(nested).build
    end
  end

  def build_form_attributes(listing)
    build_nested_attributes(listing, :listing_usages, 10)
    build_nested_attributes(listing, :listing_equipments, 10)
    build_nested_attributes(listing, :listing_stations, 5)
    build_nested_attributes(listing, :photos, 7)
    build_nested_attributes(listing, :pre_settlements, 7)
  end

  def with_transaction
    Listing.transaction do
      yield
    end
  end

end
