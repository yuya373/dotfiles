require 'gmail'
require 'nkf'
require 'csv'

need = []
Gmail.connect('test.spacee@gmail.com', 'spacee604') do |gmail|
  gmail.inbox.emails.each do |mail|
    begin
      mail = mail.envelope
    rescue Exception => e
      puts e.message
      puts e.backtrace.inspect
    end

    if mail
      p subject = NKF.nkf('-mw', mail.subject)
      date = mail.date
    end

    if subject[/No:/]
      need << [ subject, date ]
    end
  end
end

CSV.open("gmail_pre_booking.csv", "wb", headers: true) do |csv|
  csv << ["subject", "date"]
  need.each do |mail|
    csv << mail
  end
end
