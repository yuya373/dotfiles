class Provider::PricePlanSetupsController < ProviderApplicationController
  include ProviderScheduler
  include ProvidersListing
  before_action :set_listing
  layout "provider/after_sign_in"

  def new
    if @listing.listing_setup.present?
      redirect_to new_provider_listing_calendar_configurations_path(@listing)
      return
    end
    @app_props = {
      :listingId         => @listing.id,
      :pricePlanTemplate => default_scheduler_prices,
      :apiSaveData       => provider_listing_price_plan_setup_path(@listing),
    }
  end

  def create
    param = price_plan_params
    Listing.transaction do
      @listing.create_listing_setup(cleaning_minutes: param[:cleaning_minutes])
      PricePlan.setup(@listing, param[:weekday], param[:holiday])
    end
    render json:  {
      :result   => "success",
      :messages => [],
      :nextUri  => new_provider_listing_calendar_configurations_path(@listing)
    }
  end

  private

  def price_plan_params
    {
      weekday: from_scheduler_price_plan(params[:weekdayPlan]),
      holiday: from_scheduler_price_plan(params[:weekendPlan]),
      cleaning_minutes: params[:cleaningMinutes].to_i,
    }
  end
end
