class Users::OmniUsersController < ApplicationController
  def facebook
    omni = request.env["omniauth.auth"]
    omni_user = OmniUser.find_by_provider_and_uid(omni['provider'], omni['uid'])
    user = User.find_by_email(omni['info']['email'])

    if omni_user
      flash[:notice] = "ログインしました。"
      sign_in_and_redirect( :user, User.find(omni_user.user_id) )

    elsif current_user
      token = omni['credentials'].token
      token_secret = omni['credentials'].secret
      current_user.omni_users.create!(
        provider: omni['provider'],
        uid: omni['uid'],
        token: token,
        token_secret: token_secret
      )
      flash[:notice] = "Facebookを登録しました。"
      redirect_to user_user_path

    elsif user.present?
      flash[:notice] =<<-STR
        お使いのメールアドレスはすでに登録されています。
      STR
      redirect_to new_user_session_path

    else
      user = set_user(omni)
      user.apply_omniauth(omni)
      if user.save
        flash[:notice] = "ログインしました。"
        sign_in_and_redirect User.find(user.id)
      else
        session[:omniauth] = omni.except('extra')
        redirect_to new_user_registration_path
      end
    end
  end

  TODO 連携を解除するメソッド
  def destroy
    omni_user = OmniUser.find params[:id]
    omni_user.delete
    flash[:notice] = "Facebookの登録を解除しました。"
    redirect_to user_user_path
  end

  def set_user(omni)
    omni['info']['email'] = nil if omni['info']['email'].include?('@facebook.com')
    User.new(
      email: omni['info']['email'],
      name: omni['info']['name'],
      agreement: true
    )
  end

  def after_sign_in_path_for(resource)
    user_root_path
  end


end
