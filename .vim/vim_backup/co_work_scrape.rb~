require 'rubygems'
require 'nokogiri'
require 'open-uri'
require 'csv'

url = 'http://co-work-ing.com/list/list-tokyo.html'

doc = Nokogiri::HTML(open(url))

tr = doc.css("table.tableList tr")

td = tr.map{ |tr| tr.css("td")[5] }.delete_if{ |td| td.nil? }

company_url = td.map{ |td| td.css("a").attribute("href").text }
company = {}

def get_contact(tr)
  info = tr.select{ |tr|
    td = tr.css("td")[0].text
    td == "ホームページ" || td == "住所" || td == "お問い合わせ" }.map{|tr| tr.css("td")[1].text.strip }
end

def get_service(tr)
   th = tr.select{ |tr|
    tr.children[0].text == "サービス" }[0].css("td p").text.split("\n").map!{|sr| sr.strip}
end

def get_price(tr)
  th = tr.select{ |tr|
    td = tr.children[0].text == "料金プラン"
  }
end

com = company_url.map{ |url|
  url = "http://co-work-ing.com/" + url.gsub("..", '')
  # url = "http://co-work-ing.com/detail/tokyo/detail-tokyo-agora.html"
  # url = "http://co-work-ing.com/detail/tokyo/detail-tokyo-wissquare-nipponbashi.html"
  doc = Nokogiri::HTML(open(url))
  mail = doc.css("table.tableDetail a").select{|att| att.attribute("href").text.include?("@")}.map{|att| att.text}
  title = doc.css("h2").text
  tr = doc.css("table.tableDetail tr")
  contact = get_contact(tr)
  service = get_service(tr)

  company = [ title, mail[0], contact[0].tr("TEL：", ''), contact[1].gsub(/\r\n\t*/,''), contact[2], service ]
}

CSV.open('co_work.csv','wb', headers: true) do |csv|
  csv << %w(name mail tel address url service)
  com.each do |company|
    csv << company
  end
end
