/** @jsx React.DOM */

define([
    "react",
    "components/mixins/DatetimeHelper",
    "components/helpers/PricePlanHelper"
  ], function(React, DatetimeHelper, PricePlanHelper) {
  var SlotPriceViewer = React.createClass({
    getInitialState: function() {
      return {
        "hidden"    : true,
        "style"     : {},
        "priceTable": {},
        "startsAt"  : null,
        "endsAt"    : null
      };
    },
    /*
     * Render
     */
    render: function() {
    console.log("PriceViewer rendered");
      if(this.state.hidden === true) { return <div></div>; }
      // var contentStyle = {"display": (this.state.hidden) ? "none" : "block" };
      var contentStyle = {"display":"block"};
      return (
        <div className="slot-prompt-shell" style={this.state.style}>
          <div className="slot-price-viewer mod mod-default mod-round" style={contentStyle}>
            <div className="viewer-header">
              料金
            </div>
            <div className="inner-mod">
              {this.renderContent()}
            </div>
          </div>
        </div>
      );
    },
    // <span className="viewer-close" onClick={this.dismiss}>
    //   <i className="icon-remove"></i>
    // </span>

    renderContent: function () {
      return (
        <table className="table table-bordered table-fit table-small">
          {this.state.priceArray.map(this.makePriceRow)}
        </table>
      );
    },
    makePriceRow: function(price) {
      return (
        <tr>
          <th>{price.startsAt}〜{price.endsAt}</th>
          <td>{price.price}円</td>
        </tr>
      );
    },
    /*
     * Set Content
     */
    makePriceArray: function(startsAt, endsAt, priceTable) {
      var timeTableKeys = DatetimeHelper.timeTableKeysInRange(startsAt, endsAt),
          table         = PricePlanHelper.makeTimeTable(timeTableKeys, priceTable),
          priceGroup    = PricePlanHelper.groupTimeTableByPrice(timeTableKeys, table),
          prices        = PricePlanHelper.priceGroupToArray(priceGroup);
      return prices;
     },

    /*
     * Show & Hide
     */
    show: function(params) {
      this.setState({
        "hidden"    : false,
        "style"     : params.style,
        "priceArray": this.makePriceArray(params.startsAt, params.endsAt, params.priceTable)
      });
      // bind click outside
      // var t = this;
      // window.setTimeout(function() {
      //   $(t.getDOMNode()).bind("clickoutside", t.dismiss);
      // }, 500);
    },
    dismiss: function() {
      this.setState({"hidden":true});
      // unbind click outside
      $(this.getDOMNode()).unbind("clickoutside");
    },
    isShown: function() {
      return (this.state.hidden === false);
    }
  });

  return SlotPriceViewer;

});
