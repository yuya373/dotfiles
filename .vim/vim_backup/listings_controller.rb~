class Provider::ListingsController < ProviderApplicationController
  include ListingEditable
  before_action :set_listing, except: [:index, :new, :create]

  def index
    @listings = current_provider.listings.includes(:listing_setup)
  end

  def show
  end

  def new
    @listing = Listing.new(
      tel: current_provider.tel,
      email: current_provider.provider_users.first.email
    )
    build_form_attributes(@listing)
  end

  def edit
    build_form_attributes(@listing)
    render layout: "provider/edit_listing"
  end

  def create
    @listing = Listing.new(listing_params)
    @listing.provider = current_provider

    if with_transaction{ @listing.save }
      #AdminNotificationMailer.delay.new_listing_mail(@listing.id)
      redirect_to new_provider_listing_photo_url(@listing)
    else
      build_form_attributes(@listing)
      render action: :new
    end
  end

  def update
    if with_transaction{ @listing.update(listing_params) }
      if @listing.listing_setup.blank?
        redirect_to new_provider_listing_price_plan_setup_url(@listing)
        return
      end
      redirect_to [:provider, @listing], notice: "スペースの情報を更新しました。"
    else
      build_form_attributes(@listing)
      render action: 'edit'
    end
  end

  #TODO transaction
  def publish
    @listing.update!(is_display: true)
    redirect_to [:provider, @listing], notice: "スペースを公開しました。"
  end

  private

  def set_listing
    @listing = current_provider.listings.find params[:id]
  end

  def listing_params
    super.tap do |param|
      param.delete("is_approved")
    end
  end
end
