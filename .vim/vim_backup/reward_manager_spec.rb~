require 'spec_helper'

describe RewardManager, '#grant_login_points' do
  let(:customer){ create(:customer) }

  specify '日付変更時刻をまたいで2回ログインすると2ポイント増える' do
    Time.zone = 'Tokyo'
    date_boundary = Time.zone.local(2014,1,1,5,0,0)
    expect {
      Timecop.freeze(date_boundary.advance(seconds: -1))
      RewardManager.new(customer).grant_login_points
      Timecop.freeze(date_boundary)
      RewardManager.new(customer).grant_login_points
    }.to change{ customer.points }.by(2)
  end

  specify '日付変更時刻をまたがずにログインしてもポイントは1つしか増えない' do
    Time.zone = 'Tokyo'
    date_boundary = Time.zone.local(2014,1,1,5,0,0)
    expect {
      Timecop.freeze(date_boundary)
      RewardManager.new(customer).grant_login_points
      Timecop.freeze(date_boundary.advance(seconds: -1))
      RewardManager.new(customer).grant_login_points
    }.to change{ customer.points }.by(1)
  end

  specify '土曜日にログインすると3ポイントもらえる' do
    Time.zone = 'Tokyo'
    date_boundary = Time.zone.local(2014,1,4,12,0,0)
    expect {
      Timecop.freeze(date_boundary)
      RewardManager.new(customer).grant_login_points
    }.to change{ customer.points }.by(4)
  end
end
