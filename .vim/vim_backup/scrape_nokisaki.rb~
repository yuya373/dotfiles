require 'rubygems'
require 'nokogiri'
require 'open-uri'
require 'active_support/core_ext'
require 'csv'

num = 0
ary = []

while num <= 10000 do
  url = "http://nokisaki.com/Article/Detail/View/01-#{sprintf("%05d", num)}"
  # url = "http://www.nokisaki.com/Article/Detail/View/01-01318"
  root = "http://www.nokisaki.com"

  doc = Nokogiri::HTML(open(url))
  space =  doc.css("dl.info-list.clearfix dd")
  frame = doc.css("iframe")
  if frame.present?
    frame_url = frame.attribute("src").text
    price_doc = Nokogiri::HTML(open( root + frame_url ))
    price = price_doc.css("tr.line-bookable td.cell-price")
  end



  if space.present? && price.present?
    title = space[0].text
    id = space[1].text
    address = space[2].text.chomp!
    station =  space[3].text.chomp!
    size = space[5].text
    price = price.first.text
    # info = {
      # id: id,
      # title: title,
      # address: address,
      # station: station,
      # size: size,
      # price: price
    # }
    info = [id, title, address, station, size, price]

    ary << info
  end


  num += 1
end

CSV.open("nokisaki.csv", "wb", headers: true) do |csv|
  csv << [id, title, address, station, size, price]
  ary.each do |row|
    csv << row
  end
end

